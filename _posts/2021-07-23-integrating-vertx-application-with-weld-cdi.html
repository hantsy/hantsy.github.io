---
layout: post
title: Integrating Vertx application with Weld/CDI
---

<p>In <a href="https://github.com/hantsy/vertx-sandbox/blob/master/docs/spring.md">the last post</a>, we introduced a simple approach to integrate Vertx applications with Spring framework. In this post, we will try to integrate Vertx application with <a href="https://www.cdi-spec.org">CDI</a> to replace Spring.</p><figure><img alt="" src="https://cdn-images-1.medium.com/max/1024/1*IVMaWX4HIdNF5Aw45m5nCQ.jpeg" /><figcaption>Photo by <a href="https://unsplash.com/@robynnexy?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText">Robynne Hu</a> on <a href="https://unsplash.com/s/photos/china-landscape?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText">Unsplash</a></figcaption></figure><blockquote><em>CDI is a Dependency and Injection specification which is introduced in Java EE 6, currently Java EE is renamed to Jakarta EE and maintained by Eclipse Foundation. Weld is a compatible provider of the Jakarta CDI specification.</em></blockquote><p>Add the following dependencies.</p><pre>&lt;dependency&gt;<br>    &lt;groupId&gt;org.jboss.weld.se&lt;/groupId&gt;<br>    &lt;artifactId&gt;weld-se-shaded&lt;/artifactId&gt;<br>    &lt;version&gt;${weld.version}&lt;/version&gt;<br>&lt;/dependency&gt;<br>&lt;dependency&gt;<br>    &lt;groupId&gt;org.jboss&lt;/groupId&gt;<br>    &lt;artifactId&gt;jandex&lt;/artifactId&gt;<br>    &lt;version&gt;2.2.3.Final&lt;/version&gt;<br>&lt;/dependency&gt;</pre><p>In the above codes:</p><ul><li>The weld-se-shaded provides a CDI runtime environment for Java SE platform.</li><li>The jandex will index the classes in the application and speed up the bean searching.</li></ul><p>Add an empty beans.xml configuration in the <em>main/resources/META-INF</em> folder which is to enable CDI support in a Java SE application.</p><pre>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;<br>&lt;beans<br>        xmlns=&quot;http://xmlns.jcp.org/xml/ns/javaee&quot;<br>        xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;<br>        xsi:schemaLocation=&quot;http://xmlns.jcp.org/xml/ns/javaee<br>                      http://xmlns.jcp.org/xml/ns/javaee/beans_2_0.xsd&quot;<br>        bean-discovery-mode=&quot;annotated&quot;&gt;<br>&lt;/beans&gt;</pre><blockquote><em>In the Java EE/Jakarta EE world, CDI is enabled by default since Java EE 7, and the beans.xml configuration file is optional.</em></blockquote><p>Similar to the Spring version, add a DemoApplication to start the application.</p><pre>public class DemoApplication {</pre><pre>    private final static Logger LOGGER = Logger.getLogger(DemoApplication.class.getName());</pre><pre>    public static void main(String[] args) {<br>        var weld = new Weld();<br>        var container = weld.initialize();<br>        var vertx = container.select(Vertx.class).get();<br>        var factory = container.select(VerticleFactory.class).get();</pre><pre>        LOGGER.info(&quot;vertx clazz:&quot; + vertx.getClass().getName());//Weld does not create proxy classes at runtime on @Singleton beans.<br>        LOGGER.info(&quot;factory clazz:&quot; + factory.getClass().getName());<br>        // deploy MainVerticle via verticle identifier name<br>        //var deployOptions = new DeploymentOptions().setInstances(4);<br>        vertx.deployVerticle(factory.prefix() + &quot;:&quot; + MainVerticle.class.getName());<br>    }<br>}</pre><p>Here we uses weld.initialize() to initialize the CDI container. Then retrieve the Vertx bean and VerticleFactory bean, and start to deploy the MainVerticle.</p><p>Similar to the SpringAwareVerticleFactory , create a CDI aware VerticleFactory.</p><pre>@ApplicationScoped<br>public class CdiAwareVerticleFactory implements VerticleFactory {<br>    <br>    @Inject<br>    private Instance&lt;Object&gt; instance;</pre><pre>    @Override<br>    public String prefix() {<br>        return &quot;cdi&quot;;<br>    }</pre><pre>    @Override<br>    public void createVerticle(String verticleName, ClassLoader classLoader, Promise&lt;Callable&lt;Verticle&gt;&gt; promise) {<br>        String clazz = VerticleFactory.removePrefix(verticleName);<br>        promise.complete(() -&gt; (Verticle) instance.select(Class.forName(clazz)).get());<br>    }<br>}</pre><p>Create a simple Resources classes and expose the Vertx and PgPool beans.</p><pre>@ApplicationScoped<br>public class Resources {<br>    private final static Logger LOGGER = Logger.getLogger(Resources.class.getName());</pre><pre>    @Produces<br>    @Singleton<br>    public Vertx vertx(VerticleFactory verticleFactory) {<br>        Vertx vertx = Vertx.vertx();<br>        vertx.registerVerticleFactory(verticleFactory);<br>        return vertx;<br>    }</pre><pre>    @Produces<br>    public PgPool pgPool(Vertx vertx) {<br>        PgConnectOptions connectOptions = new PgConnectOptions()<br>            .setPort(5432)<br>            .setHost(&quot;localhost&quot;)<br>            .setDatabase(&quot;blogdb&quot;)<br>            .setUser(&quot;user&quot;)<br>            .setPassword(&quot;password&quot;);</pre><pre>        // Pool Options<br>        PoolOptions poolOptions = new PoolOptions().setMaxSize(5);</pre><pre>        // Create the pool from the data object<br>        PgPool pool = PgPool.pool(vertx, connectOptions, poolOptions);</pre><pre>        return pool;<br>    }</pre><pre>    public void disposesPgPool(@Disposes PgPool pgPool) {<br>        LOGGER.info(&quot;disposing PgPool...&quot;);<br>        pgPool.close().onSuccess(v -&gt; LOGGER.info(&quot;PgPool is closed successfully.&quot;));<br>    }<br>}</pre><p>Other beans are similar to the Spring version, but using CDI @ApplicaitonScoped to replace the Spring @Component.</p><pre>@ApplicationScoped<br>@RequiredArgsConstructor<br>public class MainVerticle extends AbstractVerticle {<br>    final PostsHandler postHandlers;<br>    <br>    //...<br>}</pre><pre>@ApplicationScoped<br>@RequiredArgsConstructor<br>class PostsHandler {<br>    private final PostRepository posts;<br>    <br>    //...<br>}</pre><pre>@ApplicationScoped<br>@RequiredArgsConstructor<br>public class PostRepository {</pre><pre>    private final PgPool client;<br>    <br>    //...<br>}</pre><pre>@ApplicationScoped<br>@RequiredArgsConstructor<br>public class DataInitializer {</pre><pre>    private  final PgPool client;<br>    <br>    //...<br>}</pre><p>Please note, in the above Resources class, we add a @Singleton to the Vertx, which is a little different from the ApplicationScoped, Weld does not create a proxy object for it.</p><blockquote><em>Here we have to add </em><em>@Singleton on Vertx bean, else there is an error of casting to </em><em>VertxImpl at the application startup stage, because CDI does not create a proxy bean for </em><em>VertxImpl.</em></blockquote><p>In the DemoApplication, we have added some log to print the class name of Vertx and VerticleFactory beans. When starting the application, in the console, you will see the class names as the following.</p><pre>//..<br>INFO: vertx clazz:io.vertx.core.impl.VertxImpl<br>//...<br>INFO: factory clazz:com.example.demo.CdiAwareVerticleFactory$Proxy$_$$_WeldClientProxy</pre><p>By default CDI will create proxy classes for all beans, but if it is annotated with @Singletone, it will use the instance directly.</p><p>To test the application, add the following dependency to <em>test</em> scope.</p><pre>&lt;dependency&gt;<br>    &lt;groupId&gt;org.jboss.weld&lt;/groupId&gt;<br>    &lt;artifactId&gt;weld-junit5&lt;/artifactId&gt;<br>    &lt;version&gt;2.0.2.Final&lt;/version&gt;<br>    &lt;scope&gt;test&lt;/scope&gt;<br>    &lt;exclusions&gt;<br>        &lt;exclusion&gt;<br>            &lt;groupId&gt;org.junit.jupiter&lt;/groupId&gt;<br>            &lt;artifactId&gt;junit-jupiter-api&lt;/artifactId&gt;<br>        &lt;/exclusion&gt;<br>        &lt;exclusion&gt;<br>            &lt;groupId&gt;org.junit.jupiter&lt;/groupId&gt;<br>            &lt;artifactId&gt;junit-jupiter-engine&lt;/artifactId&gt;<br>        &lt;/exclusion&gt;<br>    &lt;/exclusions&gt;<br>&lt;/dependency&gt;</pre><p>Similar to the Spring version, manually deploy the Verticle in the JUnit @BeforeAll hook before running tests.</p><pre>@EnableAutoWeld<br>@AddPackages(DemoApplication.class)<br>@TestInstance(TestInstance.Lifecycle.PER_CLASS)<br>@ExtendWith(VertxExtension.class)<br>public class TestMainVerticle {<br>    private final static Logger LOGGER = Logger.getLogger(TestMainVerticle.class.getName());</pre><pre>    @Inject<br>    Instance&lt;Object&gt; context;</pre><pre>    Vertx vertx;</pre><pre>    @BeforeAll<br>    public void setupAll(VertxTestContext testContext) {<br>        vertx = context.select(Vertx.class).get();<br>        var factory = context.select(VerticleFactory.class).get();<br>        vertx.deployVerticle(factory.prefix() + &quot;:&quot; + MainVerticle.class.getName())<br>            .onSuccess(id -&gt; {<br>                LOGGER.info(&quot;deployed:&quot; + id);<br>                testContext.completeNow();<br>            });<br>    }</pre><pre>    @Test<br>    public void testVertx(VertxTestContext testContext) {<br>        assertThat(vertx).isNotNull();<br>        testContext.completeNow();<br>    }<br></pre><pre>    @Test<br>    void testGetAll(VertxTestContext testContext) {<br>        LOGGER.log(Level.INFO, &quot;running test: {0}&quot;, &quot;testGetAll&quot;);<br>        var options = new HttpClientOptions()<br>            .setDefaultPort(8888);<br>        var client = vertx.createHttpClient(options);</pre><pre>        client.request(HttpMethod.GET, &quot;/posts&quot;)<br>            .flatMap(req -&gt; req.send().flatMap(HttpClientResponse::body))<br>            .onSuccess(<br>                buffer -&gt; testContext.verify(<br>                    () -&gt; {<br>                        LOGGER.log(Level.INFO, &quot;response buffer: {0}&quot;, new Object[]{buffer.toString()});<br>                        assertThat(buffer.toJsonArray().size()).isGreaterThan(0);<br>                        testContext.completeNow();<br>                    }<br>                )<br>            )<br>            .onFailure(e -&gt; LOGGER.log(Level.ALL, &quot;error: {0}&quot;, e.getMessage()));<br>    }</pre><pre>}</pre><p>Get the <a href="https://github.com/hantsy/vertx-sandbox/tree/master/post-service-cdi">example codes from my github</a>.</p><img src="https://medium.com/_/stat?event=post.clientViewed&referrerSource=full_rss&postId=53a7617bd963" width="1" height="1" alt="">
