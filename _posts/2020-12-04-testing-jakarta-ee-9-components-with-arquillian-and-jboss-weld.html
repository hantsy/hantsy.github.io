---
layout: post
title: Testing Jakarta EE 9 Components With Arquillian and JBoss Weld
---

<p><a href="http://www.arquillian.org">Arquillian</a> (JBoss Arquillian) Core 1.7.0 added Jakarta EE 9 and the long-awaited JUnit 5 support.</p><figure><img alt="" src="https://cdn-images-1.medium.com/max/1024/1*XZgar-TMaqJ9r-ovXsLz_A.png" /></figure><p>For impatient developers, you can try to run your Jakarta EE 9/JUnit 5 based Arquillian tests against Weld container, Glassfish v6 (both managed and remote) and Apache Tomcat 10 (for Jakarta Servlet 5.0).</p><p>In this post, we will try to test the CDI components on the Weld container.</p><h3>Prerequisites</h3><ul><li>Java 8 or Java 11 (<a href="https://openjdk.java.net/install/">OpenJDK</a> or <a href="https://adoptopenjdk.net/installation.html">AdoptOpenJDK</a>)</li><li>The latest <a href="http://maven.apache.org/download.cgi">Apache Maven</a></li><li>The basic knowledge of <a href="https://junit.org/junit5/">JUnit 5</a></li><li>Get to know <a href="http://arquillian.org/guides/">the basic of Arquillian</a></li></ul><h3>Configuring Arquillian and JUnit 5</h3><p>Add Junit 5 dependencies to your project <em>pom.xml</em> file.</p><pre>&lt;dependencyManagement&gt;<br>    &lt;dependencies&gt;<br>        ...<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.junit&lt;/groupId&gt;<br>            &lt;artifactId&gt;junit-bom&lt;/artifactId&gt;<br>            &lt;version&gt;5.7.0&lt;/version&gt;<br>            &lt;type&gt;pom&lt;/type&gt;<br>            &lt;scope&gt;import&lt;/scope&gt;<br>        &lt;/dependency&gt;<br>    &lt;/dependencies&gt;<br>&lt;/dependencyManagement&gt;</pre><pre>&lt;dependencies&gt;<br>    ...<br>    &lt;dependency&gt;<br>        &lt;groupId&gt;org.junit.jupiter&lt;/groupId&gt;<br>        &lt;artifactId&gt;junit-jupiter&lt;/artifactId&gt;<br>        &lt;scope&gt;test&lt;/scope&gt;<br>    &lt;/dependency&gt;<br>&lt;/dependencies&gt;</pre><p>Add the new Arquillian JUnit 5 integration dependency.</p><pre>...<br>&lt;dependency&gt;<br>    &lt;groupId&gt;org.jboss.arquillian.junit5&lt;/groupId&gt;<br>    &lt;artifactId&gt;arquillian-junit5-container&lt;/artifactId&gt;<br>    &lt;scope&gt;test&lt;/scope&gt;<br>&lt;/dependency&gt;</pre><p>And switch to use the latest Jakarta Servlet 5.0 protocol.</p><pre>&lt;dependency&gt;<br>    &lt;groupId&gt;org.jboss.arquillian.protocol&lt;/groupId&gt;<br>    &lt;artifactId&gt;arquillian-protocol-servlet-jakarta&lt;/artifactId&gt;<br>&lt;/dependency&gt;</pre><p>Declare the version used in the <em>properties</em> section.</p><pre>&lt;arquillian-bom.version&gt;1.7.0.Alpha5&lt;/arquillian-bom.version&gt;<br>&lt;junit-jupiter.version&gt;5.7.0&lt;/junit-jupiter.version&gt;</pre><p>By default, when arquillian-protocol-servlet-jakarta is ocurred in the classpath, the <strong>Servlet 5.0</strong> protocol will be the default protocol, if you have declared the protocol in the existing <em>arquillian.xml</em> file, change it to use <strong>Servlet 5.0</strong>.</p><pre>&lt;arquillian xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xmlns=&quot;http://jboss.org/schema/arquillian&quot;<br>            xsi:schemaLocation=&quot;http://jboss.org/schema/arquillian<br>    http://jboss.org/schema/arquillian/arquillian_1_0.xsd&quot;&gt;<br>    &lt;defaultProtocol type=&quot;Servlet 5.0&quot;/&gt;<br>    <br>&lt;/arquillian&gt;</pre><h3>Configuring Arquillian Weld Container</h3><p>Add the newest arquillian-weld-embedded dependency into the project <em>pom.xml</em> file.</p><pre>&lt;dependency&gt;<br>    &lt;groupId&gt;org.jboss.arquillian.container&lt;/groupId&gt;<br>    &lt;artifactId&gt;arquillian-weld-embedded&lt;/artifactId&gt;<br>    &lt;version&gt;${arquillian-weld-embedded.version}&lt;/version&gt;<br>    &lt;scope&gt;test&lt;/scope&gt;<br>&lt;/dependency&gt;</pre><p>And also add the weld runtime into dependencies.</p><pre>&lt;dependency&gt;<br>    &lt;groupId&gt;org.jboss.weld&lt;/groupId&gt;<br>    &lt;artifactId&gt;weld-core-impl&lt;/artifactId&gt;<br>    &lt;version&gt;${weld.version}&lt;/version&gt;<br>    &lt;scope&gt;test&lt;/scope&gt;<br>&lt;/dependency&gt;</pre><p>In the Arquillian configuration file arquillian.xml, add a container specific configuration for Weld.</p><pre>&lt;container qualifier=&quot;arq-weld&quot;&gt;<br>    &lt;configuration&gt;<br>    &lt;property name=&quot;enableConversationScope&quot;&gt;true&lt;/property&gt;<br>    &lt;property name=&quot;environment&quot;&gt;SE&lt;/property&gt;<br>    &lt;/configuration&gt;<br>&lt;/container&gt;</pre><p>The enableConversationScope property allows you decide if use @ConversationScope in the tests. And there are several environment available, check the source code of <a href="https://github.com/weld/api/blob/master/weld-spi/src/main/java/org/jboss/weld/bootstrap/api/Environments.java">Environments</a>.</p><p>As a CDI container, we can not run all Jakarta EE compoennts with Weld, for example, the Jakarta Restul WebService resources.</p><p>So let’s exclude the components that can not be run in the Weld containers, and focus on testing CDI components.</p><pre>&lt;plugin&gt;<br>    &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;<br>    &lt;artifactId&gt;maven-failsafe-plugin&lt;/artifactId&gt;<br>    &lt;version&gt;${maven-failsafe-plugin.version}&lt;/version&gt;<br>    &lt;configuration&gt;<br>        &lt;systemPropertyVariables&gt;<br>        	&lt;arquillian.launch&gt;arq-weld&lt;/arquillian.launch&gt;<br>        &lt;/systemPropertyVariables&gt;<br>        &lt;excludes&gt;<br>        	&lt;exclude&gt;**/it/GreetingResourceTest*&lt;/exclude&gt;<br>        &lt;/excludes&gt;<br>    &lt;/configuration&gt;<br>&lt;/plugin&gt;</pre><p>In <a href="https://github.com/hantsy/jakartaee9-starter-boilerplate">our sample project</a>, there are two integration tests will be run on Arquillian containers, let’s exclude the GreetingResourceTest which is use to expose Restful APIs.</p><p>The left is GreetingServiceTest, which is to test the functionality of a simple CDI bean GreetingService.</p><pre>@ExtendWith(ArquillianExtension.class)<br>public class GreetingServiceTest {<br>    private final static Logger LOGGER = Logger.getLogger(GreetingServiceTest.class.getName());</pre><pre>    @Deployment<br>    public static JavaArchive createDeployment() {<br>        return ShrinkWrap.create(JavaArchive.class)<br>                .addClass(GreetingMessage.class)<br>                .addClass(GreetingService.class)<br>                .addAsManifestResource(EmptyAsset.INSTANCE, &quot;beans.xml&quot;);<br>    }</pre><pre>    @Inject<br>    GreetingService service;</pre><pre>    @Test<br>    @DisplayName(&quot;testing buildGreetingMessage&quot;)<br>    public void should_create_greeting() {<br>        LOGGER.log(Level.INFO, &quot; Running test:: GreetingServiceTest#should_create_greeting ... &quot;);<br>        GreetingMessage message = service.buildGreetingMessage(&quot;Jakarta EE&quot;);<br>        assertTrue(message.getMessage().startsWith(&quot;Say Hello to Jakarta EE at &quot;),<br>                &quot;message should start with \&quot;Say Hello to Jakarta EE at \&quot;&quot;);<br>    }<br>}</pre><p>In the above codes,</p><ul><li>The new @ExtendWith(ArquillianExtension.class) replaces the old @RunWith(Arquilian.class) in <a href="https://github.com/hantsy/jakartaee8-starter">the Jakarta EE 8 version</a>.</li><li>The @Test annotation is from the org.junit.jupiter.api package which belongs to JUnit 5.</li><li>The @DisplayName annotation allows IDEs or other tools to use a friendly describable text instead of the method name in the test reporting results.</li><li>The @Deployment describes the assembly resources of the deployment archive for this test. Similar with general Jakarta EE components, you can use @Inject beans in Arquillian test classes. These two items are no difference from <a href="https://github.com/hantsy/jakartaee8-starter">the Jakarta EE 8 starter</a>.</li></ul><h3>Running tests</h3><p>Open a terminal window, enter the project root folder, execute the following command.</p><pre>mvn clean verify -Parq-weld</pre><p>In <a href="https://github.com/hantsy/jakartaee9-starter-boilerplate">the Jakarta EE 9 sample project</a>, I usually use a Maven profile to organize the resources of testing against a Arquillian container. Here arq-weld profile is configured for Weld container.</p><blockquote><em>NOTE: In the real world application development, it is an excellent practice to use Maven profiles to categorize the configurations for different environments.</em></blockquote><p>You will see the following info in the console.</p><pre>INFO:  Running test:: GreetingServiceTest#should_create_greeting ...<br>[INFO] Tests run: 1, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 2.783 s - in com.example.it.GreetingServiceTest<br>[INFO]<br>[INFO] Results:<br>[INFO]<br>[INFO] Tests run: 1, Failures: 0, Errors: 0, Skipped: 0<br>[INFO]<br>[INFO]<br>[INFO] --- maven-failsafe-plugin:3.0.0-M5:verify (integration-test) @ jakartaee9-starter-boilerplate ---<br>[INFO] ------------------------------------------------------------------------<br>[INFO] BUILD SUCCESS<br>[INFO] ------------------------------------------------------------------------<br>[INFO] Total time:  11.553 s<br>[INFO] Finished at: 2020-11-30T19:17:50+08:00<br>[INFO] ------------------------------------------------------------------------</pre><img src="https://medium.com/_/stat?event=post.clientViewed&referrerSource=full_rss&postId=f9e1add08895" width="1" height="1" alt=""><hr><p><a href="https://medium.com/swlh/testing-jakarta-ee-9-components-with-arquillian-and-weld-f9e1add08895">Testing Jakarta EE 9 Components With Arquillian and JBoss Weld</a> was originally published in <a href="https://medium.com/swlh">The Startup</a> on Medium, where people are continuing the conversation by highlighting and responding to this story.</p>
