---
layout: post
title: Building Your First Spring Native Application
---

<p>The <a href="https://spring.io/blog/2021/03/11/announcing-spring-native-beta">Spring Native beta is released</a>, it is great news for Spring developers. Quarkus got GraalVM native image and Kubernetes support since it was born, and Micronaunt and Oracle Helidon also added GraalVM support for a long time.</p><figure><img alt="" src="https://cdn-images-1.medium.com/max/1024/1*840X1gBH6J1ZrRzdyMnwKQ.jpeg" /><figcaption>The image is from <a href="https://unsplash.com/photos/sBNx8CBj12w">https://unsplash.com/photos/sBNx8CBj12w</a></figcaption></figure><p>As explained in the <a href="https://www.graalvm.org/docs/introduction/">GraalVM introduction page</a>, <em>GraalVM is a high-performance JDK distribution designed to accelerate the execution of applications written in Java and other JVM languages along with support for JavaScript, Ruby, Python, and a number of other popular languages. GraalVM’s polyglot capabilities make it possible to mix multiple programming languages in a single application while eliminating foreign language call costs.</em></p><p>With GraalVM native image, the Java application can be compiled in a system native executable or shared library, and do not need a Java virtual machine at runtime.</p><p>In this post, we will convert a simple existing <a href="https://github.com/hantsy/spring-reactive-sample/tree/master/boot-data-mongo-auditing">reactive mongo example</a> in the <a href="https://github.com/hantsy/spring-reactive-sample">hantsy/spring-reactive-sample</a> repository to a native application to experience the new feature brought by Spring Native project.</p><blockquote><em>Currently, Spring Native is an experimental project, and the 0.9.1 version works with the exact Spring Boot 2.4.4.</em></blockquote><h3>Generating a project</h3><p>Assuming you have installed the following software.</p><ul><li>Java 11</li><li>Apache Maven 3.8.1</li><li>Docker, required when building the application with spring-boot:build-image</li><li>Graal VM 21.0.0.2, required when building native image directly via native image maven plugin.</li></ul><p>Open your browser, navigate to <a href="https://start.spring.io">https://start.spring.io</a>.</p><figure><img alt="" src="https://cdn-images-1.medium.com/max/1024/0*9Esfdipj9eil4qZ5.png" /></figure><p>Generate a WebFlux project skeleton with dependencies: Spring Native, Lombok, Spring Reactive Web, Spring Data Reactive MongoDB.</p><p>Extract the files from the downloaded archive, and import into your IDE, eg. Intellij IDEA.</p><h3>Build the Application</h3><p>By default the Spring initializr has configured a maven AOT plugin to generate metadata required by GraalVM at compile stage, and a spring boot maven plugin using <a href="https://paketo.io/">paketo buildpack</a> builder paketobuildpacks/builder:tiny to transform your source codes to a cloud native application(Docker image).</p><p>Simply run the following command to build the application into a Docker image.</p><pre>mvn clean package spring-boot:build-image</pre><p>The <a href="https://docs.spring.io/spring-native/docs/current/reference/htmlsingle/index.html#getting-started-native-image">Spring Native Reference</a> also introduced build native application through native image maven plugin.</p><p>Copy the source codes from <a href="https://github.com/hantsy/spring-reactive-sample/tree/master/boot-data-mongo-auditing">reactive mongo example</a> to this project, and refactor the pom.xml and introduce multiple maven profiles, and make it work with both cases.</p><pre>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;<br>&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;<br>         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;<br>    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;<br>    &lt;parent&gt;<br>        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br>        &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;<br>        &lt;version&gt;2.4.4&lt;/version&gt;<br>        &lt;relativePath/&gt; &lt;!-- lookup parent from repository --&gt;<br>    &lt;/parent&gt;<br>    &lt;groupId&gt;com.example&lt;/groupId&gt;<br>    &lt;artifactId&gt;spring-native-demo&lt;/artifactId&gt;<br>    &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;<br>    &lt;name&gt;demo&lt;/name&gt;<br>    &lt;description&gt;Demo project for Spring Boot&lt;/description&gt;<br>    &lt;properties&gt;<br>        &lt;java.version&gt;11&lt;/java.version&gt;<br>        &lt;spring-native.version&gt;0.9.1&lt;/spring-native.version&gt;<br>    &lt;/properties&gt;<br>    &lt;dependencies&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-boot-starter-data-mongodb-reactive&lt;/artifactId&gt;<br>        &lt;/dependency&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-boot-starter-webflux&lt;/artifactId&gt;<br>        &lt;/dependency&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;<br>            &lt;artifactId&gt;lombok&lt;/artifactId&gt;<br>            &lt;optional&gt;true&lt;/optional&gt;<br>        &lt;/dependency&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;<br>            &lt;scope&gt;test&lt;/scope&gt;<br>        &lt;/dependency&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;io.projectreactor&lt;/groupId&gt;<br>            &lt;artifactId&gt;reactor-test&lt;/artifactId&gt;<br>            &lt;scope&gt;test&lt;/scope&gt;<br>        &lt;/dependency&gt;<br>    &lt;/dependencies&gt;</pre><pre>    &lt;build&gt;<br>        &lt;plugins&gt;<br>            &lt;plugin&gt;<br>                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br>                &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;<br>                &lt;configuration&gt;<br>                    &lt;excludes&gt;<br>                        &lt;exclude&gt;<br>                            &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;<br>                            &lt;artifactId&gt;lombok&lt;/artifactId&gt;<br>                        &lt;/exclude&gt;<br>                    &lt;/excludes&gt;<br>                &lt;/configuration&gt;<br>            &lt;/plugin&gt;<br>        &lt;/plugins&gt;<br>    &lt;/build&gt;<br>    &lt;profiles&gt;<br>        &lt;profile&gt;<br>            &lt;id&gt;default&lt;/id&gt;<br>            &lt;activation&gt;<br>                &lt;activeByDefault&gt;true&lt;/activeByDefault&gt;<br>            &lt;/activation&gt;<br>            &lt;build&gt;<br>                &lt;plugins&gt;<br>                    &lt;plugin&gt;<br>                        &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;<br>                        &lt;artifactId&gt;maven-surefire-plugin&lt;/artifactId&gt;<br>                        &lt;version&gt;3.0.0-M5&lt;/version&gt;<br>                        &lt;configuration&gt;<br>                            &lt;excludes&gt;<br>                                &lt;exclude&gt;**/FunctionalTests.*&lt;/exclude&gt;<br>                            &lt;/excludes&gt;<br>                        &lt;/configuration&gt;<br>                    &lt;/plugin&gt;<br>                &lt;/plugins&gt;<br>            &lt;/build&gt;<br>        &lt;/profile&gt;<br>        &lt;profile&gt;<br>            &lt;id&gt;spring-native&lt;/id&gt;<br>            &lt;dependencies&gt;<br>                &lt;dependency&gt;<br>                    &lt;groupId&gt;org.springframework.experimental&lt;/groupId&gt;<br>                    &lt;artifactId&gt;spring-native&lt;/artifactId&gt;<br>                    &lt;version&gt;${spring-native.version}&lt;/version&gt;<br>                &lt;/dependency&gt;<br>            &lt;/dependencies&gt;<br>            &lt;build&gt;<br>                &lt;plugins&gt;<br>                    &lt;plugin&gt;<br>                        &lt;groupId&gt;org.springframework.experimental&lt;/groupId&gt;<br>                        &lt;artifactId&gt;spring-aot-maven-plugin&lt;/artifactId&gt;<br>                        &lt;version&gt;${spring-native.version}&lt;/version&gt;<br>                        &lt;executions&gt;<br>                            &lt;execution&gt;<br>                                &lt;id&gt;test-generate&lt;/id&gt;<br>                                &lt;goals&gt;<br>                                    &lt;goal&gt;test-generate&lt;/goal&gt;<br>                                &lt;/goals&gt;<br>                            &lt;/execution&gt;<br>                            &lt;execution&gt;<br>                                &lt;id&gt;generate&lt;/id&gt;<br>                                &lt;goals&gt;<br>                                    &lt;goal&gt;generate&lt;/goal&gt;<br>                                &lt;/goals&gt;<br>                            &lt;/execution&gt;<br>                        &lt;/executions&gt;<br>                    &lt;/plugin&gt;<br>                &lt;/plugins&gt;<br>            &lt;/build&gt;<br>        &lt;/profile&gt;<br>        &lt;profile&gt;<br>            &lt;id&gt;build-docker-image&lt;/id&gt;<br>            &lt;build&gt;<br>                &lt;plugins&gt;<br>                    &lt;plugin&gt;<br>                        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br>                        &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;<br>                        &lt;configuration&gt;<br>                            &lt;image&gt;<br>                                &lt;name&gt;hantsy/${project.artifactId}:latest&lt;/name&gt;<br>                                &lt;builder&gt;paketobuildpacks/builder:tiny&lt;/builder&gt;<br>                                &lt;env&gt;<br>                                    &lt;BP_NATIVE_IMAGE&gt;true&lt;/BP_NATIVE_IMAGE&gt;<br>                                &lt;/env&gt;<br>                            &lt;/image&gt;<br>                        &lt;/configuration&gt;<br>                    &lt;/plugin&gt;<br>                &lt;/plugins&gt;<br>            &lt;/build&gt;<br>        &lt;/profile&gt;<br>        &lt;profile&gt;<br>            &lt;id&gt;build-native-image&lt;/id&gt;<br>            &lt;build&gt;<br>                &lt;plugins&gt;<br>                    &lt;plugin&gt;<br>                        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br>                        &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;<br>                        &lt;configuration&gt;<br>                            &lt;classifier&gt;exec&lt;/classifier&gt;<br>                        &lt;/configuration&gt;<br>                    &lt;/plugin&gt;<br>                    &lt;plugin&gt;<br>                        &lt;groupId&gt;org.graalvm.nativeimage&lt;/groupId&gt;<br>                        &lt;artifactId&gt;native-image-maven-plugin&lt;/artifactId&gt;<br>                        &lt;version&gt;21.0.0.2&lt;/version&gt;<br>                        &lt;configuration&gt;<br>                            &lt;!-- The native image build needs to know the entry point to your application --&gt;<br>                            &lt;mainClass&gt;com.example.demo.DemoApplication&lt;/mainClass&gt;<br>                        &lt;/configuration&gt;<br>                        &lt;executions&gt;<br>                            &lt;execution&gt;<br>                                &lt;goals&gt;<br>                                    &lt;goal&gt;native-image&lt;/goal&gt;<br>                                &lt;/goals&gt;<br>                                &lt;phase&gt;package&lt;/phase&gt;<br>                            &lt;/execution&gt;<br>                        &lt;/executions&gt;<br>                    &lt;/plugin&gt;</pre><pre>                &lt;/plugins&gt;<br>            &lt;/build&gt;<br>        &lt;/profile&gt;<br>        &lt;profile&gt;<br>            &lt;id&gt;functional-test&lt;/id&gt;<br>            &lt;build&gt;<br>                &lt;plugins&gt;<br>                    &lt;plugin&gt;<br>                        &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;<br>                        &lt;artifactId&gt;maven-surefire-plugin&lt;/artifactId&gt;<br>                        &lt;version&gt;3.0.0-M5&lt;/version&gt;<br>                        &lt;configuration&gt;<br>                            &lt;includes&gt;<br>                                &lt;include&gt;**/FunctionalTests.*&lt;/include&gt;<br>                            &lt;/includes&gt;<br>                        &lt;/configuration&gt;<br>                    &lt;/plugin&gt;<br>                &lt;/plugins&gt;<br>            &lt;/build&gt;<br>        &lt;/profile&gt;<br>    &lt;/profiles&gt;<br>    &lt;repositories&gt;<br>        &lt;repository&gt;<br>            &lt;id&gt;spring-releases&lt;/id&gt;<br>            &lt;name&gt;Spring Releases&lt;/name&gt;<br>            &lt;url&gt;https://repo.spring.io/release&lt;/url&gt;<br>        &lt;/repository&gt;<br>    &lt;/repositories&gt;<br>    &lt;pluginRepositories&gt;<br>        &lt;pluginRepository&gt;<br>            &lt;id&gt;spring-releases&lt;/id&gt;<br>            &lt;name&gt;Spring Releases&lt;/name&gt;<br>            &lt;url&gt;https://repo.spring.io/release&lt;/url&gt;<br>        &lt;/pluginRepository&gt;<br>    &lt;/pluginRepositories&gt;</pre><pre>&lt;/project&gt;</pre><p>By default, we do not contain any Spring native facilities that when run the application it works like a general Spring Boot application.</p><ul><li>The spring-native profile contains the build progress of AOT maven plugin.</li><li>The build-docker-image will build the application into a docker image via paketobuildpacks/builder:tiny builder.</li><li>The build-native-image will use GraalVM native image to build the application as system native executable.</li><li>The functional-test includes a simple FunctionalTests to verify if the application is working as expected from a client view.</li></ul><h3>Building with Paket BuildPacks</h3><p>The Paket BuildPacks requires docker environment, <a href="https://docs.docker.com/engine/install/">install it</a> firstly.</p><pre>mvn clean package spring-boot:build-image -Pspring-native,build-docker-image -DskipTests</pre><p>The application requires a running MongoDB at runtime. There is a <a href="https://github.com/hantsy/spring-native-example/blob/master/docker-compose.yml">docker-compose.yml</a> available to bootstrap a MongoDB service in seconds.</p><pre>docker-compose up mongodb</pre><p>Now run the application as any other Docker applications.</p><pre>docker run -rm hantsy/spring-native-demo</pre><h3>Building with Native Image maven plugin</h3><p>Make sure you have installed GraalVM firstly, follow the <a href="https://www.graalvm.org/docs/getting-started/">Getting Started</a> guide to install it.</p><blockquote><em>Under Windows, GraalVM is still experimental. Consider installing it into a WSL2 system, and IDEA and VSCode have great WSL support.</em></blockquote><pre>mvn clean package spring-boot:build-image -Pspring-native,build-native-image -DskipTests</pre><p>When there is an executable file in the <em>target</em> folder. Note before running this command, make sure there is a running Mongo service.</p><pre>./target/com.example.demo.demoapplication</pre><p>You will feel the native application building progress is fairly slow and tedious, both way will consume a couple of minutes (not seconds), it is terrible at development stage for developers. I would like to move it to a CI(continuous integration) service to build it for you.</p><h3>Continuous Integrations</h3><p>I prepared <a href="https://github.com/hantsy/spring-native-example/tree/master/.github/workflows">3 Github actions workflow files</a> to build the project.</p><ul><li>build - build and run testing code like the general Spring Boot applications.</li><li>build-docker-image - build the application into a layered docker image via spring-boot:build-image goal, and start up the application and verify it using FunctionalTests mentioned above.</li><li>build-native-image - build the application into system native executable via GraalVM native image, and start up it and verify the functionality by running FunctionalTests.</li></ul><p>Ideally, when building Spring Native applications, we only need to focus on the development like building a general Spring Boot application, let CI to hand over the tedious work of building native applications.</p><p>But unfortunately, there are a lot of limitations in the current version, check the <a href="https://docs.spring.io/spring-native/docs/current/reference/htmlsingle/index.html#support">Support</a> section to get a check list of the supported features at the moment. To use those features are not in the support list, you could have to give up <em>Spring Native</em> and switch back to use JVM again.</p><blockquote><em>I also tried to enable Data Mongo auditing feature, it does not work on the native mode.</em></blockquote><h4><em>Grab a copy of the source codes from </em><a href="https://github.com/hantsy/spring-native-example/"><em>hantsy/spring-native-example</em></a><em> to experience yourself.</em></h4><h3>The Final Words</h3><p>Quarkus invents the Arc container which provides a subset of CDI APIs for developers, but integrally it produces static codes for beans at compile time instead of generating dynamic proxies at runtime.</p><p>In my opinion, I would like to see some similar mechanism in Spring Native that provides compile-time byte code enhancement to replace the Spring built-in dynamic proxies for beans, and make it as an alternative to the current Spring IOC container. Personally, I am a little disappointed.</p><img src="https://medium.com/_/stat?event=post.clientViewed&referrerSource=full_rss&postId=ae169136e544" width="1" height="1" alt=""><hr><p><a href="https://medium.com/geekculture/building-your-first-spring-native-application-ae169136e544">Building Your First Spring Native Application</a> was originally published in <a href="https://medium.com/geekculture">Geek Culture</a> on Medium, where people are continuing the conversation by highlighting and responding to this story.</p>
