---
layout: post
title: Consuming GraphQL APIs with Quarkus
---

<p>In <a href="https://hantsy.medium.com/building-graphql-apis-with-quarkus-dbbf23f897df">the last post</a>, we have built a simple GraphQL API example, now let’s discuss how to use GraphQL Client to interact with the backend GraphQL APIs.</p><figure><img alt="" src="https://cdn-images-1.medium.com/max/1024/1*ooWBcjq6RawM_2U54kWWxA.jpeg" /><figcaption>The image is from <a href="https://unsplash.com/photos/6NzHYsK_-Ow">https://unsplash.com/photos/6NzHYsK_-Ow</a></figcaption></figure><h3>Generating Project Skeleton</h3><p>Like what we have done in the past posts, you should prepare a project skeleton firstly.</p><p>Create a Quarkus project using <a href="https://code.quarkus.io">Quarkus Code Generator</a>, import the source codes into your IDE.</p><p>Open <em>pom.xml</em> file, add the following dependencies.</p><pre>&lt;dependency&gt;<br>    &lt;groupId&gt;io.quarkus&lt;/groupId&gt;<br>    &lt;artifactId&gt;quarkus-smallrye-graphql-client&lt;/artifactId&gt;<br>&lt;/dependency&gt;<br>&lt;dependency&gt;<br>    &lt;groupId&gt;io.quarkus&lt;/groupId&gt;<br>    &lt;artifactId&gt;quarkus-rest-client&lt;/artifactId&gt;<br>&lt;/dependency&gt;<br>&lt;dependency&gt;<br>    &lt;groupId&gt;io.quarkus&lt;/groupId&gt;<br>    &lt;artifactId&gt;quarkus-rest-client-jsonb&lt;/artifactId&gt;<br>&lt;/dependency&gt;<br>&lt;dependency&gt;<br>    &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;<br>    &lt;artifactId&gt;lombok&lt;/artifactId&gt;<br>    &lt;version&gt;1.18.20&lt;/version&gt;<br>&lt;/dependency&gt;</pre><p>Lombok is used to erase the setters, getters, hashCode, equals, toString etc. in your POJO classes and make it looks clean.</p><h3>Declaring GraphQL Client API</h3><p>Similar to the MicroProfile RestClient spec, SmallRye GraphQL provides the same approach to declare a GraphQL Client from an interface.</p><blockquote><em>Note, this Client API is not a part of MicroProfile GraphQL specification.</em></blockquote><pre>@GraphQLClientApi<br>public interface PostGraphQLClient {<br>    @Query()<br>    public List&lt;Post&gt; getAllPosts() ;</pre><pre>    @Query<br>    @Description(&quot;Get a specific post by providing an id&quot;)<br>    public Post getPostById(@Name(&quot;postId&quot;) String id);</pre><pre>    @Mutation<br>    @Description(&quot;Create a new post&quot;)<br>    public Post createPost(@Valid CreatePost createPostInput);<br>}</pre><p>The POJO classes used in the above codes, such as Post, Coment and CreatePost are copied from <a href="https://github.com/hantsy/quarkus-sandbox/blob/master/graphql">the backend GraphQL API project</a> we have created in the last post.</p><p>To locate which remote GraphQL API will be connected, similar to the MP RestClient API, configure the base URI of the remote GraphQL API.</p><pre>com.example.demo.PostGraphQLClient/mp-graphql/url=http://localhost:8080/graphql</pre><p>Now let’s try to call the getAllPosts of PostGraphQLClient and print out all posts.</p><p>Create a class implements QuarkusApplication and annotated it with @QuarkusMain, it will work like the main class in a general Java application.</p><pre>@QuarkusMain<br>public class Main implements QuarkusApplication {<br>    public static final Logger LOGGER = Logger.getLogger(Main.class.getName());</pre><pre>    @Inject<br>    PostGraphQLClient clientApi;</pre><pre>    @Override<br>    public int run(String... args) throws Exception {<br>        this.clientApi.getAllPosts().forEach(<br>            p -&gt; LOGGER.log(Level.INFO, &quot;post: {0}&quot;, p)<br>        );<br>        return 0;<br>    }<br>}</pre><p>Open your terminal and switch to the project root folder. Run mvn quarkus:dev to start the application in dev mode. After it is started, you will see the following info in the console log.</p><pre>2021-06-03 20:21:00,505 INFO  [io.sma.gra.cli.typ.jax.JaxRsTypesafeGraphQLClientProxy] (Quarkus Main Thread) request graphql: query allPosts { allPosts {id title content countOfComment<br>s comments {id content}} }<br>2021-06-03 20:21:00,517 INFO  [com.exa.dem.Main] (Quarkus Main Thread) post: Post(id=9ef6d49f-50bf-4973-a122-3ac56a1b8d41, title=title #1, content=test content of #1, countOfComments=2<br>, comments=[Comment(id=e261e9cb-f06c-4989-bbb5-00319087496d, content=comment #1), Comment(id=7664a80f-0963-46c1-8955-c096d7609c1b, content=comment #2)])<br>2021-06-03 20:21:00,517 INFO  [com.exa.dem.Main] (Quarkus Main Thread) post: Post(id=0c5501eb-cb7e-42e2-9078-040af89e6310, title=title #2, content=test content of #2, countOfComments=2<br>, comments=[Comment(id=bf4e2553-cb59-4e87-bc8f-36360732a919, content=comment #1), Comment(id=165d6743-fd74-4ad5-8997-3853fb076403, content=comment #2)])<br>2021-06-03 20:21:00,517 INFO  [com.exa.dem.Main] (Quarkus Main Thread) post: Post(id=c61c6b62-584b-455f-a2a8-1a4253f832b7, title=title #3, content=test content of #3, countOfComments=0<br>, comments=[])<br>2021-06-03 20:21:00,517 INFO  [com.exa.dem.Main] (Quarkus Main Thread) post: Post(id=37e28b7d-11fc-4587-920f-9415da1d93a3, title=title #4, content=test content of #4, countOfComments=2<br>, comments=[Comment(id=5963588f-fbe0-4c82-88f6-1011bb7538fe, content=comment #1), Comment(id=feaf4d21-e78b-4701-91bb-ea665a9a034c, content=comment #2)])</pre><p>Comparing to REST APIs, the most attractive feature of GraphQL is it only returns the required fields that are requested by client. In the above the codes it returns all fields of a Post.</p><p>Assume you just want to retrieve the <em>title</em> field in the result when executing the allPosts query, try to create a new POJO class just includes a <em>title</em> property.</p><pre>@Getter<br>@Setter<br>@NoArgsConstructor<br>@AllArgsConstructor<br>@ToString<br>public class PostSummary {<br>    String title;<br>}</pre><p>Add a new method into the above PostGraphQLClient class.</p><pre>@Query(&quot;allPosts&quot;)<br>public List&lt;PostSummary&gt; getAllPostSummaries() ;</pre><p>Let’s call it and print out the result.</p><pre>this.clientApi.getAllPostSummaries().forEach(<br>    p -&gt; LOGGER.log(Level.INFO, &quot;post summary: {0}&quot;, p)<br>);</pre><p>You can see the following info from the application log.</p><pre>2021-06-03 20:21:00,533 INFO  [io.sma.gra.cli.typ.jax.JaxRsTypesafeGraphQLClientProxy] (Quarkus Main Thread) request graphql: query allPosts { allPosts {title} }<br>2021-06-03 20:21:00,533 INFO  [com.exa.dem.Main] (Quarkus Main Thread) post summary: PostSummary(title=title #1)<br>2021-06-03 20:21:00,533 INFO  [com.exa.dem.Main] (Quarkus Main Thread) post summary: PostSummary(title=title #2)<br>2021-06-03 20:21:00,533 INFO  [com.exa.dem.Main] (Quarkus Main Thread) post summary: PostSummary(title=title #3)<br>2021-06-03 20:21:00,533 INFO  [com.exa.dem.Main] (Quarkus Main Thread) post summary: PostSummary(title=title #4)</pre><p>As you expected, it only requests the <em>title</em> field in the GraphQL query, and return the exact fields in the response.</p><h3>Handling Client Exceptions</h3><p>Currently when calling the Client APIs, Quarkus does not provide a registry for handling exceptions like MP RestClient API, but there are some possible means to archive the purpose.</p><p>The hard way is using try/catch to handle the GraphQLClientException, eg.</p><pre>String id = UUID.randomUUID().toString();<br>// catch a GraphQLClientException.<br>try {<br>    var p = this.clientApi.getPostById(id);<br>    LOGGER.log(Level.INFO, &quot;post: {0}&quot;, p);<br>} catch (GraphQLClientException e) {<br>    if (e.getErrors().stream().anyMatch(error -&gt; error.getErrorCode().equals(&quot;POST_NOT_FOUND&quot;))) {<br>        throw new PostNotFoundException(id);<br>    }<br>}</pre><p>In the above codes, if the postId is not existed, it will throw a GraphQLClientException.</p><p>Besides this, wrapping your response with ErrorOr class is an alternative solution.</p><pre>@Query<br>@Description(&quot;Get a specific post by providing an id&quot;)<br>public ErrorOr&lt;Post&gt; getPostById(@Name(&quot;postId&quot;) String id);</pre><p>ErrorOr is very similar to the Java Optional, you can navigate one of two parts, <strong>data</strong> and <strong>errors</strong>. When the errors exists, the getErrors method will collect all errors from the backend GraphQL API in a slient way(comparing to the try/catch method).</p><pre>String id = UUID.randomUUID().toString();</pre><pre>// return a `ErrorOr` instead.<br>var post = this.clientApi.getPostById(id);<br>if (post.isPresent()) {<br>    LOGGER.log(Level.INFO, &quot;found: {0}&quot;, post.get());<br>}<br>if (post.isError()) {<br>    post.getErrors().forEach(<br>        error -&gt; LOGGER.log(Level.INFO, &quot;error: code={0}, message={1}&quot;, new Object[]{error.getErrorCode(), error.getMessage()})<br>    );<br>}</pre><p>When running the application, you can see the following log.</p><pre>2021-06-03 20:21:00,423 INFO  [io.sma.gra.cli.typ.jax.JaxRsTypesafeGraphQLClientProxy] (Quarkus Main Thread) request graphql: query postById($arg0: String) { postById(postId: $arg0) {i<br>d title content countOfComments comments {id content}} }<br>2021-06-03 20:21:00,505 INFO  [com.exa.dem.Main] (Quarkus Main Thread) error: code=POST_NOT_FOUND, message=Post: 8c46ca01-530e-47c1-a257-e86333bcb69b was not found.</pre><h3>Dynamic Client</h3><p>We have discussed the client using @GraphQLClientApi, Quarkus also provide a <strong>dynamic client</strong>. It is more like a Java translation of the GraphQL request form.</p><p>For example, perform the following query in the <a href="http://localhost:8080/q/graphql-ui/">GraphQL UI</a> to retrieve all posts.</p><pre>query {<br>  allPosts {<br>    id<br>    title<br>    content<br>    comments {<br>      id<br>      content<br>    }<br>  }<br>}</pre><p>Create a new bean to do the same work.</p><pre>@ApplicationScoped<br>public class PostDynamicClient {</pre><pre>    @Inject<br>    @NamedClient(&quot;post-dynamic-client&quot;)<br>    DynamicGraphQLClient dynamicClient;</pre><pre>    public List&lt;Post&gt; getAllPosts() throws ExecutionException, InterruptedException {<br>        Document query = document(<br>                operation(<br>                        field(&quot;allPosts&quot;,<br>                                field(&quot;id&quot;),<br>                                field(&quot;title&quot;),<br>                                field(&quot;content&quot;),<br>                                field(&quot;comments&quot;,<br>                                        field(&quot;id&quot;),<br>                                        field(&quot;content&quot;)<br>                                )<br>                        )<br>                )<br>        );<br>        Response response = dynamicClient.executeSync(query);<br>        return response.getList(Post.class, &quot;allPosts&quot;);<br>    }<br>}</pre><p>Through the document, operation and field static methods, we build the same query structure in Java <em>dialect</em>.</p><p>The value of NamedClient to identify different clients, which is also used as the configuration key in the <em>application.properties</em>.</p><pre>post-dynamic-client/mp-graphql/url=http://localhost:8080/graphql</pre><p>Now try to call the getAllPosts of this client and print out all posts.</p><pre>@Inject<br>PostDynamicClient dynamicClient;</pre><pre>this.dynamicClient.getAllPosts().forEach(<br>    p -&gt; LOGGER.log(Level.INFO, &quot;post from dynamic client: {0}&quot;, p)<br>);</pre><p>Run the application and you can see the following info.</p><pre>1, countOfComments=0, comments=[Comment(id=e261e9cb-f06c-4989-bbb5-00319087496d, content=comment #1), Comment(id=7664a80f-0963-46c1-8955-c096d7609c1b, content=comment #2)])<br>2021-06-03 20:21:01,507 INFO  [com.exa.dem.Main] (Quarkus Main Thread) post from dynamic client: Post(id=0c5501eb-cb7e-42e2-9078-040af89e6310, title=title #2, content=test content of #<br>2, countOfComments=0, comments=[Comment(id=bf4e2553-cb59-4e87-bc8f-36360732a919, content=comment #1), Comment(id=165d6743-fd74-4ad5-8997-3853fb076403, content=comment #2)])<br>2021-06-03 20:21:01,507 INFO  [com.exa.dem.Main] (Quarkus Main Thread) post from dynamic client: Post(id=c61c6b62-584b-455f-a2a8-1a4253f832b7, title=title #3, content=test content of #<br>3, countOfComments=0, comments=[])<br>2021-06-03 20:21:01,507 INFO  [com.exa.dem.Main] (Quarkus Main Thread) post from dynamic client: Post(id=37e28b7d-11fc-4587-920f-9415da1d93a3, title=title #4, content=test content of #<br>4, countOfComments=0, comments=[Comment(id=5963588f-fbe0-4c82-88f6-1011bb7538fe, content=comment #1), Comment(id=feaf4d21-e78b-4701-91bb-ea665a9a034c, content=comment #2)])</pre><h3>HttpClient</h3><p>In Quarkus, the GraphQL client is shaking hands with the backend GraphQL API over HTTP protocol. Ideally if you are familiar with GraphQL interexchange format(json), you can use any HttpClient to send a <em>POST</em> request to perform the GraphQL query, including cURL, Resteasy Client/JAXRS Client or the simple Java 11 HttpClient.</p><p>The following is an example using cUrlcommand.</p><pre>curl <a href="http://localhost:8080/graphql">http://localhost:8080/graphql</a> -H &quot;Accept: application/json&quot; -H &quot;Content-Type: application/json&quot; -d &quot;{\&quot;query\&quot;: \&quot;query {  allPosts {  id title content comments { id  content } } }\&quot; }&quot;<br>{&quot;data&quot;:{&quot;allPosts&quot;:[{&quot;id&quot;:&quot;5049edc2-58a0-4a0a-9204-753fc4541fa0&quot;,&quot;title&quot;:&quot;title #1&quot;,&quot;content&quot;:&quot;test content of #1&quot;,&quot;comments&quot;:[{&quot;id&quot;:&quot;1124e65f-bf4b-41a1-9f34-4daab83b3a31&quot;,&quot;content&quot;:&quot;comment #1&quot;},{&quot;id&quot;:&quot;cc68bc61-3769-4a9c-a572-fdd66f6ebffe&quot;,&quot;content&quot;:&quot;comment #2&quot;},{&quot;id&quot;:&quot;3d9164d1-9da9-4483-abcb-6d29ffc3b938&quot;,&quot;content&quot;:&quot;comment #3&quot;},{&quot;id&quot;:&quot;fbba10b4-9309-442b-8b25-c2ef6e25023c&quot;,&quot;content&quot;:&quot;comment #4&quot;}]},{&quot;id&quot;:&quot;d3c130ea-f537-4b77-8125-70b620469c9f&quot;,&quot;title&quot;:&quot;title #2&quot;,&quot;content&quot;:&quot;test content of #2&quot;,&quot;comments&quot;:[{&quot;id&quot;:&quot;a28d8b31-65fe-4058-a9bc-739731f5b7d6&quot;,&quot;content&quot;:&quot;comment #1&quot;},{&quot;id&quot;:&quot;855b6773-305d-488a-932e-5cc12eb51c93&quot;,&quot;content&quot;:&quot;comment #2&quot;},{&quot;id&quot;:&quot;74b1e329-2b85-4e3e-82e8-2b49cc3d387b&quot;,&quot;content&quot;:&quot;comment #3&quot;}]},{&quot;id&quot;:&quot;2325744b-46ef-4061-bc03-8f0ca5d7c955&quot;,&quot;title&quot;:&quot;title #3&quot;,&quot;content&quot;:&quot;test content of #3&quot;,&quot;comments&quot;:[{&quot;id&quot;:&quot;54217aae-9db1-4403-bbd5-f341e4a53d84&quot;,&quot;content&quot;:&quot;comment #1&quot;}]},{&quot;id&quot;:&quot;407dd60c-966c-4d82-b260-f58edba7db14&quot;,&quot;title&quot;:&quot;title #4&quot;,&quot;content&quot;:&quot;test content of #4&quot;,&quot;comments&quot;:[{&quot;id&quot;:&quot;f46c8c3e-ddbc-48eb-8a0f-952081bf6d35&quot;,&quot;content&quot;:&quot;comment #1&quot;},{&quot;id&quot;:&quot;394a8bec-5e0c-4a69-8b82-a71a4f856778&quot;,&quot;content&quot;:&quot;comment #2&quot;}]}]}}</pre><p>In Java 11, a new HttpClient is added, the following is an example using this HttpClient.</p><pre>@ApplicationScoped<br>public class JvmClient {<br>    private final ExecutorService executorService = Executors.newFixedThreadPool(5);</pre><pre>    private final HttpClient httpClient = HttpClient.newBuilder()<br>            .executor(executorService)<br>            .version(HttpClient.Version.HTTP_2)<br>            .build();<br></pre><pre>    @Inject<br>    Jsonb jsonb;</pre><pre>    CompletionStage&lt;List&lt;Post&gt;&gt; getAllPosts() {</pre><pre>        // Have to erase the new line chars in the GraphQL schema to avoid the parsing exception.<br>        // see: <a href="https://github.com/quarkusio/quarkus/issues/17667">https://github.com/quarkusio/quarkus/issues/17667</a><br>        var queryString = &quot;&quot;&quot;<br>                {&quot;query&quot;: &quot;query {<br>                            allPosts {<br>                              id<br>                              title<br>                              content<br>                              comments {<br>                                id<br>                                content<br>                              }<br>                            }<br>                          }&quot;<br>                }<br>                &quot;&quot;&quot;.replaceAll(&quot;\\n&quot;, &quot; &quot;);<br>        var request = HttpRequest.newBuilder()<br>                .POST(HttpRequest.BodyPublishers.ofString(queryString))<br>                .uri(URI.create(&quot;http://localhost:8080/graphql&quot;))<br>                .header(&quot;Accept&quot;, &quot;application/json&quot;)<br>                .header(&quot;Content-Type&quot;, &quot;application/json&quot;)<br>                .build();<br>        HttpResponse.BodyHandler&lt;String&gt; handler = HttpResponse.BodyHandlers.ofString();<br>        return this.httpClient<br>                .sendAsync(request, handler)<br>                .thenApply(HttpResponse::body)<br>                .thenApply(this::extractPosts);</pre><pre>    }</pre><pre>    /**<br>     * @param s the GraphQL response, eg.<br>     * @formatter:off<br>     *          {<br>     *              data:{<br>     *                  allPosts: [<br>     *                      {<br>     *                      id:&quot;xxxx&quot;,<br>     *                      title:&quot;test title&quot;,<br>     *                      content:&quot;content&quot;<br>     *                      }<br>     *                  ]<br>     *              }<br>     *          }<br>     * @formatter:on<br>     * @return The parsed the list of post data.<br>     */<br>    List&lt;Post&gt; extractPosts(String s) {<br>        var reader = new StringReader(s);<br>        var json = Json.createReader(reader).read();<br>        var pointer = Json.createPointer(&quot;/data/allPosts&quot;);<br>        var jsonArray = (JsonArray) pointer.getValue(json);<br>        //@formatter:off<br>        return jsonb.fromJson(jsonArray.toString(), new TypeLiteral&lt;List&lt;Post&gt;&gt;() {}.getRawType());<br>        //@formatter:on<br>    }<br>}</pre><p>To extract posts data from the GraphQL client response, I use JSONP Pointer to locate the <em>posts</em> JSON array, and convert it to List&lt;Post&gt; by JsonB. Add the jsonp extension to the project deps.</p><pre>mvn quarkus:add-extension -Dextensions=&quot;jsonp&quot;</pre><blockquote><em>The </em>text block<em> is great to compose a multiline string, but there is </em><a href="https://github.com/quarkusio/quarkus/issues/17667"><em>an issue</em></a><em> which causes the GraphQL schema parsing failed. Finally I add a </em><em>replaceAll method to erase the newline breaks to overcome this issue temporarily.</em></blockquote><p>Try to call the getAllPosts of this client.</p><pre>@Inject<br>JvmClient jvmClient;</pre><pre>this.jvmClient.getAllPosts()<br>    .thenAccept(<br>    	p -&gt; LOGGER.log(Level.INFO, &quot;post from jvm client: {0}&quot;, p)<br>	)<br>    .whenComplete((d, e) -&gt; LOGGER.info(&quot;The request is done in the jvm client.&quot;))<br>    .toCompletableFuture()<br>    .join();</pre><p>Run the application you will see the following in the application log.</p><pre>2021-06-03 20:21:01,662 INFO  [com.exa.dem.Main] (ForkJoinPool.commonPool-worker-7) post from jvm client: [{comments=[{id=e261e9cb-f06c-4989-bbb5-00319087496d, content=comment #1}, {id<br>=7664a80f-0963-46c1-8955-c096d7609c1b, content=comment #2}], id=9ef6d49f-50bf-4973-a122-3ac56a1b8d41, title=title #1, content=test content of #1}, {comments=[{id=bf4e2553-cb59-4e87-bc8<br>f-36360732a919, content=comment #1}, {id=165d6743-fd74-4ad5-8997-3853fb076403, content=comment #2}], id=0c5501eb-cb7e-42e2-9078-040af89e6310, title=title #2, content=test content of #2<br>}, {comments=[], id=c61c6b62-584b-455f-a2a8-1a4253f832b7, title=title #3, content=test content of #3}, {comments=[{id=5963588f-fbe0-4c82-88f6-1011bb7538fe, content=comment #1}, {id=fea<br>f4d21-e78b-4701-91bb-ea665a9a034c, content=comment #2}], id=37e28b7d-11fc-4587-920f-9415da1d93a3, title=title #4, content=test content of #4}]<br>2021-06-03 20:21:01,662 INFO  [com.exa.dem.Main] (ForkJoinPool.commonPool-worker-7) The request is done in the jvm client.</pre><p>There is another version implemented by Jaxrs Client included in the source codes. If you are interested in it, explore the <a href="https://github.com/hantsy/quarkus-sandbox/blob/master/graphql-client/src/main/java/com/example/demo/JaxrsClient.java">JaxrsClient example</a> yourself.</p><h4><a href="https://github.com/hantsy/quarkus-sandbox/blob/master/graphql-client">Get the complete source codes from my Github</a>.</h4><img src="https://medium.com/_/stat?event=post.clientViewed&referrerSource=full_rss&postId=a2f482b6169d" width="1" height="1" alt="">
